<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <script src="https://d3js.org/d3.v6.js"></script>
        <style>
            *
            {
                font-size: large  ;
                font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            }
            .controls 
            {
                display: flex;
                flex-direction: row;
            }
            body 
            {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                justify-content: center;
            }
        </style>

    </head>
    <body>
        <div>
            <h2>World Happiness Report</h2>
            <h1 class="text-center">Homework #2: D3 Simple</h1>
            <h3 class="text-center">Worifung Achu - wachu1@asu.edu</h3>
            <h3>click on a bubble to see more details</h3>

        </div>
        <div class="controls">
            <div>
                <label for="x-axis">year:</label>
                <select id='year'>
                    
                </select>
            </div>
   
            <div class="selector">
                <label for="y-axis">Y-Axis:</label>
                <select id="y-axis">
                    <option value="Healthy life expectancy at birth">life
                        expectancy</option>
                    <option
                        value="Freedom to make life choices">freedom</option>
                    <option value="Generosity">Generosity</option>
                    <option value="Perceptions of corruption">Perception of
                        corruption</option>
                    <option value="Log GDP per capita">Log GDP
                        percapita</option>
                    <option value="Social support">Social support</option>
                </select>
            </div>
        </div>
        <svg id="chart" width="1000" height="900"></svg>
        <svg id="radial_chart" width="1000" height="900"></svg>

        <script>
            const margin = { top: 10, right: 20, bottom: 30, left: 50 },
                width = 850 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;
        
            const svg = d3.select("#chart")
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
        
            // Create a tooltip div
            const tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("background", "#f9f9f9")
                .style("border", "1px solid #ccc")
                .style("padding", "8px")
                .style("border-radius", "4px")
                .style("font-size", "12px")
                .style("pointer-events", "none");
        
            d3.csv('./datasets/world-happiness-report-2005-2021.csv').then(function (data) {
                const yearSelect = document.getElementById('year');
                //populating the year selector box
                for (let i = 2021; i >= 2005; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                const yAxisSelect = document.getElementById('y-axis');
        
                function updateChart() {
                    const selectedYear = yearSelect.value;
                    const yVariable = yAxisSelect.value;
                    drawData(data, selectedYear, yVariable);
                }
        
                yearSelect.addEventListener('change', updateChart);
                yAxisSelect.addEventListener('change', updateChart);
        
                updateChart(); // Initial rendering
            });
        
            function drawData(data, year, yVariable) {
                svg.selectAll("*").remove();


        
                data = data.filter(d => d.year == year);
        
                const x = d3.scaleLinear().domain([0, 10]).range([0, width]);
                svg.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x));
        
                const y = d3.scaleLinear()
                    .domain([d3.min(data, d => +d[yVariable]) * 0.99, d3.max(data, d => +d[yVariable]) * 1.01])
                    .range([height, 0]);
                svg.append("g").call(d3.axisLeft(y));
        
                const z = d3.scaleLinear().domain(d3.extent(data, d => +d[yVariable])).range([3, 10]);

                // Add X axis label:
svg.append("text")
    .attr("text-anchor", "end")
    .attr("x", width)
    .attr("y", height + margin.top + 25)
    .text("Ladder Score");

    // Y axis label:
svg.append("text")
    .attr("text-anchor", "end")
    .attr("transform", "rotate(-90)")
    .attr("y", -margin.left+15)
    .attr("x", -margin.top)
    .text(yVariable);
        
                svg.append("g")
                    .selectAll("circle")
                    .data(data)
                    .join("circle")
                    .attr("cx", d => x(d['Ladder score']))
                    .attr("cy", d => y(d[yVariable]))
                    .attr("r", d => z(d[yVariable]))
                    .style("fill", d => d.color || "#69b3a2")
                    .style("opacity", 0.7)
                    .on("mouseover", function (event, d) {
    tooltip.style("visibility", "visible")
        .html(`<strong>${d['Country name']}</strong><br>${yVariable}: ${d[yVariable]}<br>Ladder score: ${d['Ladder score']}`);
    d3.select(this).style("stroke", "black").style("stroke-width", 2);
})
.on("mousemove", function (event) {
    tooltip.style("top", `${event.pageY + 10}px`)
        .style("left", `${event.pageX + 10}px`);
})
.on("mouseout", function () {
    tooltip.style("visibility", "hidden");
    d3.select(this).style("stroke", "none");
})
.on("click", function (event, d) {
    const maxValues = {
        "Log GDP per capita": d3.max(data, d => +d['Log GDP per capita']),
        "Social support": d3.max(data, d => +d['Social support']),
        "Healthy life expectancy at birth": d3.max(data, d => +d['Healthy life expectancy at birth']),
        "Freedom to make life choices": d3.max(data, d => +d['Freedom to make life choices']),
        "Generosity": d3.max(data, d => +d['Generosity']),
        "Perceptions of corruption": d3.max(data, d => +d['Perceptions of corruption']),
        "Ladder score": d3.max(data, d => +d['Ladder score'])
    }
    drawRadialChart(d, maxValues);

            });
            }


            function drawRadialChart(data, maxValues) {
                console.log('data', data);
                console.log('maxValues', maxValues);
                
            // Clear any existing chart
            d3.select("#radial_chart").selectAll("*").remove();

            const margin = { top: 50, right: 50, bottom: 50, left: 50 },
                width = 900 - margin.left - margin.right,
                height = 900 - margin.top - margin.bottom;

            const svg = d3.select("#radial_chart")
                .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);

            // Metrics to visualize (excluding non-numeric or empty fields)
            const metrics = [
                'Ladder score',
                'Log GDP per capita', 
                'Social support', 
                'Healthy life expectancy at birth', 
                'Freedom to make life choices', 
                'Perceptions of corruption'
            ];

            // Prepare data
            const processedData = metrics.map(metric => ({
                axis: metric,
                value: +data[metric],
                maxValue: maxValues[metric]
            }));
            
            console.log('processedData', processedData);
            

            // Radial scale
            const radialScale = d3.scaleLinear()
                .domain([0, 1])
                .range([0, Math.min(width, height) / 2 - 100]);

            // Color scale
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

            // Create radial grid lines
            const gridLines = svg.append("g")
                .attr("class", "gridlines");

            // Number of grid circles
            const gridCount = 5;
            for (let i = 1; i <= gridCount; i++) {
                gridLines.append("circle")
                    .attr("cx", 0)
                    .attr("cy", 0)
                    .attr("r", radialScale(i/gridCount))
                    .attr("fill", "none")
                    .attr("stroke", "#e0e0e0")
                    .attr("stroke-width", 1);
            }

            // Angle calculation
            const angleSlice = Math.PI * 2 / metrics.length;

            // Draw axes
            const axesLines = svg.append("g")
                .attr("class", "axes");

            metrics.forEach((metric, i) => {
                const angle = i * angleSlice;
                const lineCoords = {
                    x1: 0,
                    y1: 0,
                    x2: radialScale(1) * Math.cos(angle - Math.PI/2),
                    y2: radialScale(1) * Math.sin(angle - Math.PI/2)
                };

                axesLines.append("line")
                    .attr("x1", lineCoords.x1)
                    .attr("y1", lineCoords.y1)
                    .attr("x2", lineCoords.x2)
                    .attr("y2", lineCoords.y2)
                    .attr("stroke", "#c0c0c0")
                    .attr("stroke-width", 1);

                // Add axis labels
                const labelRadius = radialScale(1.2);
                const labelX = labelRadius * Math.cos(angle - Math.PI/2);
                const labelY = labelRadius * Math.sin(angle - Math.PI/2);

                svg.append("text")
                    .attr("x", labelX)
                    .attr("y", labelY)
                    .attr("text-anchor", "middle")
                    .attr("alignment-baseline", "middle")
                    .attr("font-size", "13px")
                    .text(`${formatLabel(metric, data[metric])}`);
            }); 

            // Create the polygon
            const lineFunction = d3.line()
                .x(d => {
                    const angle = metrics.indexOf(d.axis) * angleSlice;
                    return radialScale(d.value/d.maxValue) * Math.cos(angle - Math.PI/2);
                })
                .y(d => {
                    const angle = metrics.indexOf(d.axis) * angleSlice;
                    return radialScale(d.value/d.maxValue) * Math.sin(angle - Math.PI/2);
                })
                .curve(d3.curveCardinalClosed);

            svg.append("path")
                .attr("d", lineFunction(processedData))
                .attr("stroke", colorScale(0))
                .attr("fill", colorScale(0))
                .attr("fill-opacity", 0.3)
                .attr("stroke-width", 2);

            // Add dots for each metric
            processedData.forEach((d, i) => {
                const angle = i * angleSlice;
                const radius = radialScale(d.value/d.maxValue);

                svg.append("circle")
                    .attr("cx", radius * Math.cos(angle - Math.PI/2))
                    .attr("cy", radius * Math.sin(angle - Math.PI/2))
                    .attr("r", 5)
                    .attr("fill", colorScale(0))
                    .on("mouseover", function(event) {
                        const tooltip = d3.select("#tooltip");
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`${d.axis}: ${d.value.toFixed(3)}`)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip")
                            .transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            });
        }


        function formatLabel(metric, value) {
            value = parseFloat(value);
            
    // Customize what to display based on the metric
    switch (metric) {
    case "Log GDP per capita":
        return `GDP: ${Math.round(value * 100) / 100}`;
    case "Social support":
        return `Social Support: ${Math.round(value * 100) / 100}`;
    case "Healthy life expectancy at birth":
        return `Life Expectancy: ${Math.round(value * 100) / 100}`;
    case "Freedom to make life choices":
        return `Freedom: ${Math.round(value * 100) / 100}`;
    case "Perceptions of corruption":
        return `Corruption: ${Math.round(value * 100) / 100}`;
    default:
        return `${metric}: ${Math.round(value * 100) / 100}`;
}

}
        </script>

    </body>
</html>